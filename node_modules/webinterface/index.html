<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phish cracker web interface</title>
    <link rel="stylesheet" href="etc/css/bootstrap.min.css">
    <link rel="stylesheet" href="etc/css/bootstrap-theme.min.css">
</head>
<body>
<div class="container">
    <div class="row">
        <h1 class="h1">
            Phish cracker web interface.
        </h1>
    </div>
    <hr>
    <div class="row">
        <div class="col-xs-4">
            <form method="post" action="/" id="ulist-form">
                <div class="form-group">
                    <label for="ulist">Urls to check</label>
                    <textarea name="ulist" id="ulist" class="form-control" placeholder="Enter some urls delimited by line break symbol"></textarea>
                </div>
                <button type="submit" id="ulist-send" class="btn btn-default">Send</button>
            </form>
        </div>
        <div class="col-xs-8" id="content">
            <p>
                <img src="green.png"> — не фишинг; <img src="red.png"> — фишинг; <img src="yellow.png"> — не удалось получить сведения;
            </p>

        </div>
    </div>
</div>

</body>
<script src="https://code.jquery.com/jquery-3.2.1.min.js" type="text/javascript"></script>
<script src="etc/js/bootstrap.min.js" type="text/javascript"></script>
<script type="text/javascript">
    $("#ulist-form").submit(function(e) {
       e.preventDefault();
       var form = this;
       $.ajax({
          type: "POST",
          url: "/",
          data: $(this).serialize(),
          success: function(msg){
                $("textarea", form).val('');
                if(!$.contains(document.getElementById("content"), document.getElementById("table-repr"))) {
                    $("#content").append(
                        '<table id="table-repr" class="table table-bordered table-responsive text-center">' +
                        '<tr>' +
                        '<th>url</th>' +
                        '<th>URL Algo</th>' +
                        '<th>Image Algo</th>' +
                        '</tr>' +
                        '</table>');
                }
                var rows = {};
                var emptyCounter = 0;
                (function worker() {
                  $.ajax({
                    url: '/checker',
                    type: "GET",
                    success: function(data) {
                        if (data.length !== 0) {
                            emptyCounter = 0;
                            console.log(data);
                            var arr = data;
                            for (var i = 0; i < arr.length; i++) {
                                var dict = arr[i];
                                console.log(dict);
                                if (dict['url'] in rows) {
                                    var trelem = rows[dict['url']];
                                    var willchange;
                                    if (dict['algo'] === "URLS_ALGO") {
                                        willchange = $("#ualgo", trelem);
                                    }
                                    if (dict['algo'] === "IMAGE_ALGO") {
                                        willchange = $("#ialgo", trelem);
                                    }
                                    if (dict['answer'] === 1) {
                                        willchange.html("<img src='red.png' title='phishing'>");
                                    } else if (dict['answer'] === 0) {
                                        willchange.html("<img src='green.png' title='not phishing'>");
                                    } else  {
                                        willchange.html("<img src='yellow.png' title='bad sample'>");
                                    }

                                } else {
                                    var trelem = $('<tr/>', {});
                                    $('<td/>', {id: 'url', html: "<a href='"+ dict["url"]+ "'>" + dict['url'] + "</a>"}).appendTo(trelem);
                                    var willchange = $('<td/>', {id: 'ualgo'});

                                    if (dict['answer'] === 1) {
                                        willchange.html("<img src='red.png' title='phishing'>");
                                    } else if (dict['answer'] === 0) {
                                        willchange.html("<img src='green.png' title='not phishing'>");
                                    } else  {
                                        willchange.html("<img src='yellow.png' title='bad sample'>");
                                    }

                                    if (dict['algo'] === "URLS_ALGO") {
                                        willchange.attr("id", "ualgo");
                                        willchange.appendTo(trelem);
                                        $('<td/>', {id: 'ialgo', html: "<img src='spinner.gif'>"}).appendTo(trelem);
                                    }
                                    if (dict['algo'] === "IMAGE_ALGO") {
                                        $('<td/>', {id: 'ualgo', html: "<img src='spinner.gif'>"}).appendTo(trelem);
                                        willchange.attr("id", "ialgo");
                                        willchange.appendTo(trelem);
                                    }

                                    trelem.appendTo("#table-repr");
                                    rows[dict['url']] = trelem;
                                }
                            }
                        } else {
                            emptyCounter += 1;
                        }
                    },
                    complete: function() {
                      // Schedule the next request when the current one's complete
                        console.log(emptyCounter);
                        if (emptyCounter < 20) {
                            setTimeout(worker, 3000);
                        }
                    }
                  });
                })();
          }
        });
    });
</script>
</html>